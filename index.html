
<html>
    <head>
        <style type="text/css">
            
/*
    Fluid Baseline Grid v1.0.0
    Designed & Built by Josh Hopkins and 40 Horse, http://40horse.com
    Licensed under Unlicense, http://unlicense.org/

    Base stylesheet with CSS normalization, typographic baseline grid and progressive responsiveness
*/

/* HTML5 DECLARATIONS */
article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section, dialog {display: block}
audio[controls],canvas,video {display: inline-block; *display: inline; zoom: 1}

/* BASE */
html {height: 100%; font-size: 100%; overflow-y: scroll; -webkit-text-size-adjust: 100%} /* Force scrollbar in non-IE and Remove iOS text size adjust without disabling user zoom */
body {margin: 0; min-height: 100%; -webkit-font-smoothing:antialiased; font-smoothing:antialiased; text-rendering:optimizeLegibility; background:url('../images/24px_grid_bg.gif') 0 1.1875em} /* Improve default text rendering, handling of kerning pairs and ligatures */

/* DEFAULT FONT SETTINGS */
/* 16px base font size with 150% (24px) friendly, unitless line height and margin for vertical rhythm */
/* Font-size percentage is based on 16px browser default size */
body, button, input, select, textarea {font: 100%/1.5 Georgia,Palatino,"Palatino Linotype",Times,"Times New Roman",serif; *font-size: 1em; color: #333} /* IE7 and older can't resize px based text */
p, blockquote, q, pre, address, hr, code, samp, dl, ol, ul, form, table, fieldset, menu, img {margin: 0 0 1.5em; padding: 0}

/* TYPOGRAPHY */
/* Composed to a scale of 12px, 14px, 16px, 18px, 21px, 24px, 36px, 48px, 60px and 72px */
h1, h2, h3, h4, h5, h6 {font-family:Futura, "Century Gothic", AppleGothic, sans-serif;color:#222;text-shadow:1px 1px 1px rgba(0,0,0,.10)}
h1 {margin: 0; font-size: 3.75em; line-height: 1.2em; margin-bottom: 0.4em} /* 60px / 72px */
h2 {margin: 0; font-size: 3em; line-height: 1em; margin-bottom: 0.5em} /* 48px / 48px */
h3 {margin: 0; font-size: 2.25em; line-height: 1.3333333333333333333333333333333em; margin-bottom: 0.6667em} /* 36px / 48px */ 
h4 {margin: 0; font-size: 1.5em; line-height: 1em; margin-bottom: 1em} /* 24px / 24px */
h5 {margin: 0; font-size: 1.3125em; line-height: 1.1428571428571428571428571428571em; margin-bottom: 1.1428571428571428571428571428571em} /* 21px / 24px */
h6 {margin: 0; font-size: 1.125em; line-height: 1.3333333333333333333333333333333em; margin-bottom: 1.3333333333333333333333333333333em} /* 18px / 24px */
p, ul, blockquote, pre, td, th, label {margin: 0; font-size: 1em; line-height: 1.5em; margin-bottom: 1.5em} /* 16px / 24px */
small, p.small {margin: 0; font-size: 0.875em; line-height: 1.7142857142857142857142857142857em; margin-bottom: 1.7142857142857142857142857142857em} /* 14px / 24px */

/* CODE */
pre {white-space: pre; white-space: pre-wrap; word-wrap: break-word} /* Allow line wrapping of 'pre' */
pre, code, kbd, samp {font-size: 1em; line-height: 1.5em; margin-bottom: 1.5em; font-family: Menlo, Consolas, 'DejaVu Sans Mono', Monaco, monospace}

/* TABLES */
table {border-collapse: collapse; border-spacing: 0; margin-bottom: 1.5em}
th {text-align: left}
tr, th, td {padding-right: 1.5em; border-bottom: 0 solid #333}

/* FORMS */
form {margin: 0}
fieldset {border: 0;padding: 0}
textarea {overflow: auto; vertical-align: top}
legend {*margin-left: -.75em}
button, input, select, textarea {vertical-align: baseline; *vertical-align: middle} /* IE7 and older */
button, input {line-height: normal; *overflow: visible}
button, input[type="button"], input[type="reset"], input[type="submit"] {cursor: pointer;-webkit-appearance: button}
input[type="checkbox"], input[type="radio"] {box-sizing: border-box}
input[type="search"] {-webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box}
input[type="search"]::-webkit-search-decoration {-webkit-appearance: none}
button::-moz-focus-inner, input::-moz-focus-inner {border: 0; padding: 0}

/* QUOTES */
blockquote, q {quotes: none}
blockquote:before, blockquote:after, q:before, q:after {content: ''; content: none}
blockquote, q, cite {font-style: italic}
blockquote {padding-left: 1.5em; border-left: 3px solid #ccc}
blockquote > p {padding: 0}

/* LISTS */
ul, ol {list-style-position: inside; padding: 0}
li ul, li ol {margin: 0 1.5em}
dl dd {margin-left: 1.5em}
dt {font-family:Futura, "Century Gothic", AppleGothic, sans-serif}

/* HYPERLINKS */
a {text-decoration: none; color:#c47529}
a:hover {text-decoration: underline}
a:focus {outline: thin dotted}
a:hover, a:active {outline: none} /* Better CSS Outline Suppression */

/* MEDIA */
figure {margin: 0}
img, object, embed, video {max-width: 100%; _width: 100%} /* Fluid images */
img {border: 0; -ms-interpolation-mode: bicubic} /* Improve IE's resizing of images */
svg:not(:root) {overflow: hidden} /* Correct IE9 overflow */

/* ABBREVIATION */
abbr[title], dfn[title] {border-bottom: 1px dotted #333; cursor: help}

/* MARKED/INSERTED/DELETED AND SELECTED TEXT */
ins, mark {text-decoration: none}
mark {background: #c47529}
ins {background: #d49855}
del {text-decoration: line-through}
::-moz-selection {background: #c47529; color: #fff; text-shadow: none} /* selected text */
::selection {background: #c47529; color: #fff; text-shadow: none} /* selected text */

/* OTHERS */
strong, b, dt { font-weight: bold}
dfn {font-style: italic}
var, address {font-style: normal}
sub, sup {font-size: 75%; line-height: 0; position: relative; vertical-align: baseline} /* Position 'sub' and 'sup' without affecting line-height */
sup {top: -0.5em} /* Move superscripted text up */
sub {bottom: -0.25em} /* Move subscripted text down */
span.amp{font-family:Adobe Caslon Pro,Baskerville,"Goudy Old Style","Palatino","Palatino Linotype","Book Antiqua",Georgia,"Times New Roman",Times,serif;font-style:italic;font-size:110%;line-height:0;position:relative;vertical-align:baseline} /* Best available ampersand */

/* MICRO CLEARFIX HACK */
.cf:before, .cf:after {content:"";display:table} /* For modern browsers */
.cf:after {clear:both}
.cf {zoom:1} /* For IE 6/7 (trigger hasLayout) */

/* DEFAULT MOBILE STYLE */
body {width: 92%; margin: 0 auto} /* Center page without wrapper */
/* column grid */
.g1,.g2,.g3{display:block; position: relative; margin-left: 1%; margin-right: 1%}
/* 1 column grid */
.g1,.g2,.g3{width:98.0%}


/* media Queries

FOLDING FLUID GRID
< 767px         - 1-Column Fluid Grid
768px - 1023px  - 2-Column Fluid Grid
> 1024px            - 3-Column Fluid Grid
Change widths as necessary
------------------------------------------- */

/* MOBILE PORTRAIT */
@media only screen and (min-width: 320px) {
    body {
        
    }
}

/* MOBILE LANDSCAPE */
@media only screen and (min-width: 480px) {
    body {
        
    }
}

/* SMALL TABLET */
@media only screen and (min-width: 600px) {
    body {
        
    }
}

/* TABLET/NETBOOK */
@media only screen and (min-width: 768px) { 
    body {
        
    }
    
    /* COLUMN GRID */
    .g1,.g2,.g3 {display:inline; float: left}
    
    /* 2 COLUMN GRID */
    .g1 {width:48.0%}
    .g2 {width:48.0%}
    .g3 {width:98.0%}
}

/* LANDSCAPE TABLET/NETBOOK/LAPTOP */
@media only screen and (min-width: 1024px) { 
    body {

    }
    
    /* 3 COLUMN GRID */
    .g1 {width:31.333%}
    .g2 {width:64.667%;}
    .g3 {width:98.0%}
}

@media only screen and (min-width: 1280px) { 
/* DESKTOP */
        body {

    }
}

/* WIDESCREEN */
/* Increased body size for legibility */
@media only screen and (min-width: 1400px) { 
    body {font-size:116.75%; background:url('../images/28px_grid_bg.gif') 0 1.25em; max-width:1440px} /* 18.5px / 28px */
}


/* PRINT */
@media print {
  * {background: transparent !important; color: black !important; text-shadow: none !important; filter:none !important; -ms-filter: none !important} /* Black prints faster */
  a, a:visited {color: #444 !important; text-decoration: underline}
  a[href]:after {content: " (" attr(href) ")"}
  abbr[title]:after {content: " (" attr(title) ")"}
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after {content: ""}  /* Don't print links for images, javascript or internal links */
  pre, blockquote {border: 1px solid #999; page-break-inside: avoid; }
  thead {display: table-header-group; } /* Repeat header row at top of each printed page */
  tr, img {page-break-inside: avoid; }
  img {max-width: 100% !important; }
  @page {margin: 0.5cm}
  p, h2, h3 {orphans: 3; widows: 3}
  h2, h3{page-break-after: avoid}
}

            
.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #cc0000; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold; background-color: #fff0f0 } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #303030 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #606060 } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008800 } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #888888; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #0000DD; font-weight: bold } /* Literal.Number */
.highlight .s { color: #dd2200; background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #336699 } /* Name.Attribute */
.highlight .nb { color: #003388 } /* Name.Builtin */
.highlight .nc { color: #bb0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555 } /* Name.Decorator */
.highlight .ne { color: #bb0066; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066bb; font-weight: bold } /* Name.Function */
.highlight .nl { color: #336699; font-style: italic } /* Name.Label */
.highlight .nn { color: #bb0066; font-weight: bold } /* Name.Namespace */
.highlight .py { color: #336699; font-weight: bold } /* Name.Property */
.highlight .nt { color: #bb0066; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #336699 } /* Name.Variable */
.highlight .ow { color: #008800 } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #0000DD; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #0000DD; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #0000DD; font-weight: bold } /* Literal.Number.Oct */
.highlight .sb { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Char */
.highlight .sd { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Doc */
.highlight .s2 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #0044dd; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { color: #3333bb; background-color: #fff0f0 } /* Literal.String.Interpol */
.highlight .sx { color: #22bb22; background-color: #f0fff0 } /* Literal.String.Other */
.highlight .sr { color: #008800; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #aa6600; background-color: #fff0f0 } /* Literal.String.Symbol */
.highlight .bp { color: #003388 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700 } /* Name.Variable.Global */
.highlight .vi { color: #3333bb } /* Name.Variable.Instance */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */

        </style>
        
    </head>
    <body>
    <div id="content">
        <div class="g3">
<h2>Overview</h2>
<p>A web application serves the python script which drives our call interface, and
the web application also exposes voting results, counts votes and stores the
available options. The web application supports both the tropo web api and
scripting interfaces.</p>
<p>Here is the SQL which creates the database tables we will use and populates the
songs table:</p>
<div class="highlight"><pre><a name="data--schema.sql-pyg.html-1"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">songs</span> <span class="p">(</span>
<a name="data--schema.sql-pyg.html-2"></a>    <span class="nb">number</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
<a name="data--schema.sql-pyg.html-3"></a>    <span class="n">title</span> <span class="nb">TEXT</span><span class="p">,</span>
<a name="data--schema.sql-pyg.html-4"></a>    <span class="n">keyword</span> <span class="nb">TEXT</span><span class="p">,</span>
<a name="data--schema.sql-pyg.html-5"></a>    <span class="n">votes_cache</span> <span class="nb">INTEGER</span>
<a name="data--schema.sql-pyg.html-6"></a><span class="p">);</span>
<a name="data--schema.sql-pyg.html-7"></a>
<a name="data--schema.sql-pyg.html-8"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">number</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="ss">&quot;Piano Man by Billy Joel&quot;</span><span class="p">,</span> <span class="ss">&quot;piano&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="data--schema.sql-pyg.html-9"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">number</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="ss">&quot;Imagine by John Lennon&quot;</span><span class="p">,</span> <span class="ss">&quot;imagine&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<a name="data--schema.sql-pyg.html-10"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">number</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="ss">&quot;Rocket Man by Elton John&quot;</span><span class="p">,</span> <span class="ss">&quot;rocket&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<a name="data--schema.sql-pyg.html-11"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">number</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="ss">&quot;Crazy Little Thing Called Love by Queen&quot;</span><span class="p">,</span> <span class="ss">&quot;crazy&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<a name="data--schema.sql-pyg.html-12"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">number</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="ss">&quot;Daydream Believer by The Monkees&quot;</span><span class="p">,</span> <span class="ss">&quot;daydream&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<a name="data--schema.sql-pyg.html-13"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">number</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="ss">&quot;Sweet Caroline by Neil Diamond&quot;</span><span class="p">,</span> <span class="ss">&quot;caroline&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<a name="data--schema.sql-pyg.html-14"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">number</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="ss">&quot;Hey Jude by The Beatles&quot;</span><span class="p">,</span> <span class="ss">&quot;jude&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<a name="data--schema.sql-pyg.html-15"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">number</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="ss">&quot;Don&#39;t Stop Believin by Journey&quot;</span><span class="p">,</span> <span class="ss">&quot;believing&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<a name="data--schema.sql-pyg.html-16"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">number</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="ss">&quot;Tainted Love by Soft Cell&quot;</span><span class="p">,</span> <span class="ss">&quot;tainted&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<a name="data--schema.sql-pyg.html-17"></a>
<a name="data--schema.sql-pyg.html-18"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">votes</span> <span class="p">(</span>
<a name="data--schema.sql-pyg.html-19"></a>    <span class="n">id</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span>
<a name="data--schema.sql-pyg.html-20"></a>    <span class="n">song_number</span> <span class="nb">INTEGER</span><span class="p">,</span>
<a name="data--schema.sql-pyg.html-21"></a>    <span class="n">phone_number</span> <span class="nb">TEXT</span>
<a name="data--schema.sql-pyg.html-22"></a><span class="p">);</span>
<a name="data--schema.sql-pyg.html-23"></a>
<a name="data--schema.sql-pyg.html-24"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sessions</span> <span class="p">(</span>
<a name="data--schema.sql-pyg.html-25"></a>    <span class="n">tropo_call_id</span> <span class="nb">TEXT</span><span class="p">,</span>
<a name="data--schema.sql-pyg.html-26"></a>    <span class="n">caller_network</span> <span class="nb">TEXT</span><span class="p">,</span>
<a name="data--schema.sql-pyg.html-27"></a>    <span class="n">caller_channel</span> <span class="nb">TEXT</span><span class="p">,</span>
<a name="data--schema.sql-pyg.html-28"></a>    <span class="n">caller_id</span> <span class="nb">TEXT</span>
<a name="data--schema.sql-pyg.html-29"></a><span class="p">);</span>
</pre></div>

<h2>Getting Started</h2>
<h3>Scripting</h3>
<p>Our web application exposes a static python file which contains the script that
will be used by the scripting api. We point the tropo application to the url of
this script file.</p>
<p>http://voice.pitchlift.org/script.py</p>
<h3>WebAPI</h3>
<p>We define a starting URL which we point our tropo application to. This method
will interact only minimally with the user (maybe saying "hello"), but its
primary object is to direct the call to the appropriate handler. This might
mean differentiating between text and voice, or directing based on the caller
id or network, but even if it's just a simple redirect this is a nice option to
avoid hard-coding the starting point into the tropo application specification.
If you want to change your menu options you can simply change where this start
method points to rather than having to change the url in the tropo console.</p>
<div class="highlight"><pre><a name="app--voting_webapi.py-idio.html-132"></a><span class="k">class</span> <span class="nc">StartWebapiController</span><span class="p">(</span><span class="n">BaseWebapiController</span><span class="p">):</span>
<a name="app--voting_webapi.py-idio.html-133"></a>    <span class="k">def</span> <span class="nf">do_voice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="app--voting_webapi.py-idio.html-134"></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">Tropo</span><span class="p">()</span>
<a name="app--voting_webapi.py-idio.html-135"></a>
<a name="app--voting_webapi.py-idio.html-136"></a>        <span class="n">caller_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">votes</span><span class="o">.</span><span class="n">caller_id_if_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">call_id</span><span class="p">())</span>
<a name="app--voting_webapi.py-idio.html-137"></a>        <span class="n">web</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;starting to handle voice call from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">caller_id</span><span class="p">)</span>
<a name="app--voting_webapi.py-idio.html-138"></a>
<a name="app--voting_webapi.py-idio.html-139"></a>        <span class="k">if</span> <span class="n">models</span><span class="o">.</span><span class="n">votes</span><span class="o">.</span><span class="n">caller_id_can_vote</span><span class="p">(</span><span class="n">caller_id</span><span class="p">):</span>
<a name="app--voting_webapi.py-idio.html-140"></a>            <span class="n">t</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s">&quot;continue&quot;</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="s">&quot;/webapi/vote/menu&quot;</span><span class="p">)</span>
<a name="app--voting_webapi.py-idio.html-141"></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">caller_id</span><span class="p">:</span>
<a name="app--voting_webapi.py-idio.html-142"></a>            <span class="n">t</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s">&quot;Oops, you need to have caller eye dee enabled to vote. Goodbye.&quot;</span><span class="p">)</span>
<a name="app--voting_webapi.py-idio.html-143"></a>            <span class="n">t</span><span class="o">.</span><span class="n">hangup</span><span class="p">()</span>
<a name="app--voting_webapi.py-idio.html-144"></a>        <span class="k">else</span><span class="p">:</span>
<a name="app--voting_webapi.py-idio.html-145"></a>            <span class="n">t</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s">&quot;Oops, it looks like you have voted already. Goodbye.&quot;</span><span class="p">)</span>
<a name="app--voting_webapi.py-idio.html-146"></a>            <span class="n">t</span><span class="o">.</span><span class="n">hangup</span><span class="p">()</span>
<a name="app--voting_webapi.py-idio.html-147"></a>
<a name="app--voting_webapi.py-idio.html-148"></a>        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">RenderJson</span><span class="p">()</span>
<a name="app--voting_webapi.py-idio.html-149"></a>
<a name="app--voting_webapi.py-idio.html-150"></a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="app--voting_webapi.py-idio.html-151"></a>        <span class="c"># save session info for this call</span>
<a name="app--voting_webapi.py-idio.html-152"></a>        <span class="n">session_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">data</span><span class="p">())[</span><span class="s">&#39;session&#39;</span><span class="p">]</span>
<a name="app--voting_webapi.py-idio.html-153"></a>
<a name="app--voting_webapi.py-idio.html-154"></a>        <span class="n">tropo_call_id</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">[</span><span class="s">&#39;callId&#39;</span><span class="p">]</span>
<a name="app--voting_webapi.py-idio.html-155"></a>        <span class="n">caller_network</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">[</span><span class="s">&#39;from&#39;</span><span class="p">][</span><span class="s">&#39;network&#39;</span><span class="p">]</span>
<a name="app--voting_webapi.py-idio.html-156"></a>        <span class="n">caller_channel</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">[</span><span class="s">&#39;from&#39;</span><span class="p">][</span><span class="s">&#39;channel&#39;</span><span class="p">]</span>
<a name="app--voting_webapi.py-idio.html-157"></a>        <span class="n">caller_id</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">[</span><span class="s">&#39;from&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
<a name="app--voting_webapi.py-idio.html-158"></a>
<a name="app--voting_webapi.py-idio.html-159"></a>        <span class="n">models</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">new_session</span><span class="p">(</span>
<a name="app--voting_webapi.py-idio.html-160"></a>                <span class="n">tropo_call_id</span><span class="p">,</span>
<a name="app--voting_webapi.py-idio.html-161"></a>                <span class="n">caller_network</span><span class="p">,</span>
<a name="app--voting_webapi.py-idio.html-162"></a>                <span class="n">caller_channel</span><span class="p">,</span>
<a name="app--voting_webapi.py-idio.html-163"></a>                <span class="n">caller_id</span><span class="p">)</span>
<a name="app--voting_webapi.py-idio.html-164"></a>
<a name="app--voting_webapi.py-idio.html-165"></a>        <span class="k">if</span> <span class="n">caller_channel</span> <span class="o">==</span> <span class="s">&#39;VOICE&#39;</span><span class="p">:</span>
<a name="app--voting_webapi.py-idio.html-166"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_voice</span><span class="p">()</span>
<a name="app--voting_webapi.py-idio.html-167"></a>        <span class="k">else</span><span class="p">:</span>
<a name="app--voting_webapi.py-idio.html-168"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;unexpected caller channel </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">caller_channel</span><span class="p">)</span>
</pre></div>

<h2>Preparing the Menu: A List of Songs</h2>
<p>The point of the application is to allow callers to vote on which of the
available songs they would most like to hear. So, callers will first be
presented with a list of the available songs.</p>
<h3>Scripting</h3>
<p>Using the scripting interface, our script is run by the tropo instance so it
doesn't have direct access to the database. We need to allow it to fetch a list
of songs from our web application:</p>
<p>Here we see a method in the songs model which returns an array of song
information:</p>
<div class="highlight"><pre><a name="models--songs.py-idio.html-9"></a><span class="k">def</span> <span class="nf">songs_array</span><span class="p">():</span>
<a name="models--songs.py-idio.html-10"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a name="models--songs.py-idio.html-11"></a><span class="sd">    Returns an array of information for each song in the database.</span>
<a name="models--songs.py-idio.html-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a name="models--songs.py-idio.html-13"></a>    <span class="n">songs</span> <span class="o">=</span> <span class="p">[]</span>
<a name="models--songs.py-idio.html-14"></a>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;songs&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;number&#39;</span><span class="p">):</span>
<a name="models--songs.py-idio.html-15"></a>        <span class="n">songs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;keyword&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;number&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;votes_cache&#39;</span><span class="p">]))</span>
<a name="models--songs.py-idio.html-16"></a>    <span class="k">return</span> <span class="n">songs</span>
<a name="models--songs.py-idio.html-17"></a>
<a name="models--songs.py-idio.html-18"></a><span class="k">def</span> <span class="nf">results</span><span class="p">():</span>
<a name="models--songs.py-idio.html-19"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a name="models--songs.py-idio.html-20"></a><span class="sd">    Returns song titles and total votes sorted in order of voted preference.</span>
<a name="models--songs.py-idio.html-21"></a><span class="sd">    &quot;&quot;&quot;</span>
<a name="models--songs.py-idio.html-22"></a>    <span class="n">songs</span> <span class="o">=</span> <span class="p">[]</span>
<a name="models--songs.py-idio.html-23"></a>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;songs&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;votes_cache DESC&#39;</span><span class="p">):</span>
<a name="models--songs.py-idio.html-24"></a>        <span class="n">votes</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;votes_cache&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&quot;0&quot;</span>
<a name="models--songs.py-idio.html-25"></a>        <span class="n">songs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">],</span> <span class="n">votes</span><span class="p">))</span>
<a name="models--songs.py-idio.html-26"></a>    <span class="k">return</span> <span class="n">songs</span>
</pre></div>

<p>We expose the available songs as a simple CSV listing:</p>
<div class="highlight"><pre><a name="app--voting_scripting.py-idio.html-8"></a><span class="k">class</span> <span class="nc">SongsController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a name="app--voting_scripting.py-idio.html-9"></a>    <span class="k">def</span> <span class="nf">GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="app--voting_scripting.py-idio.html-10"></a>        <span class="n">songs_array</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">songs</span><span class="o">.</span><span class="n">songs_array</span><span class="p">()</span>
<a name="app--voting_scripting.py-idio.html-11"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
<a name="app--voting_scripting.py-idio.html-12"></a>        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span><span class="p">)</span>
<a name="app--voting_scripting.py-idio.html-13"></a>        <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">songs_array</span><span class="p">)</span>
<a name="app--voting_scripting.py-idio.html-14"></a>        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>

<div class="highlight"><pre><a name="docs--curl.sh-pyg.html-1"></a>curl http://voice.pitchlift.org/songs.csv
</pre></div>

<pre>
"Piano Man by Billy Joel","piano","1","2"
"Imagine by John Lennon","imagine","2","1"
"Rocket Man by Elton John","rocket","3",""
"Crazy Little Thing Called Love by Queen","crazy","4",""
"Daydream Believer by The Monkees","daydream","5","3"
"Sweet Caroline by Neil Diamond","caroline","6","1"
"Hey Jude by The Beatles","jude","7",""
"Don't Stop Believin by Journey","believing","8",""
"Tainted Love by Soft Cell","tainted","9",""

</pre>

<p>In our voice script, we fetch and parse this CSV data:</p>
<div class="highlight"><pre><a name="app--script.py-idio.html-14"></a><span class="n">songs_url</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">SONGS_DATA</span><span class="p">)</span>
<a name="app--script.py-idio.html-15"></a><span class="n">songs_array</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">songs_url</span><span class="p">)</span>
</pre></div>

<p>We prepare the menu prompt which will tell the user how to vote for each song
and tells Tropo what the acceptable responses are:</p>
<div class="highlight"><pre><a name="app--script.py-idio.html-18"></a><span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
<a name="app--script.py-idio.html-19"></a><span class="n">choices</span> <span class="o">=</span> <span class="p">[]</span>
<a name="app--script.py-idio.html-20"></a><span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">votes_cache</span> <span class="ow">in</span> <span class="n">songs_array</span><span class="p">:</span>
<a name="app--script.py-idio.html-21"></a>    <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">number</span><span class="p">))</span>
<a name="app--script.py-idio.html-22"></a>    <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;For </span><span class="si">%(title)s</span><span class="s">, say </span><span class="si">%(keyword)s</span><span class="s"> or press </span><span class="si">%(number)s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">())</span>
<a name="app--script.py-idio.html-23"></a><span class="n">prompt</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
</pre></div>

<h3>Web API</h3>
<p>Using the Tropo Web API, we have direct access to the database, so we prepare
the prompt directly.</p>
<div class="highlight"><pre><a name="app--voting_webapi.py-idio.html-93"></a>    <span class="k">def</span> <span class="nf">do_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="app--voting_webapi.py-idio.html-94"></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">Tropo</span><span class="p">()</span>
<a name="app--voting_webapi.py-idio.html-95"></a>        <span class="n">t</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s">&quot;hello, thank you for helping us choose the music&quot;</span><span class="p">)</span>
<a name="app--voting_webapi.py-idio.html-96"></a>
<a name="app--voting_webapi.py-idio.html-97"></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
<a name="app--voting_webapi.py-idio.html-98"></a>        <span class="n">choices</span> <span class="o">=</span> <span class="p">[]</span>
<a name="app--voting_webapi.py-idio.html-99"></a>        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">votes_cache</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">songs</span><span class="o">.</span><span class="n">songs_array</span><span class="p">():</span>
<a name="app--voting_webapi.py-idio.html-100"></a>            <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">number</span><span class="p">))</span>
<a name="app--voting_webapi.py-idio.html-101"></a>            <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;For </span><span class="si">%(title)s</span><span class="s">, say </span><span class="si">%(keyword)s</span><span class="s"> or press </span><span class="si">%(number)s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">())</span>
<a name="app--voting_webapi.py-idio.html-102"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
<a name="app--voting_webapi.py-idio.html-103"></a>
<a name="app--voting_webapi.py-idio.html-104"></a>        <span class="n">t</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="n">Choices</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">choices</span><span class="p">)),</span> <span class="n">say</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
<a name="app--voting_webapi.py-idio.html-105"></a>        <span class="n">t</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s">&quot;continue&quot;</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">response_url</span><span class="p">())</span>
<a name="app--voting_webapi.py-idio.html-106"></a>        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">RenderJson</span><span class="p">()</span>
</pre></div>

<h2>Voting</h2>
<h3>Scripting</h3>
<p>In the scripting API, we greet the caller and play the menu prompt, capturing the result:</p>
<div class="highlight"><pre><a name="app--script.py-idio.html-26"></a><span class="n">result</span> <span class="o">=</span> <span class="n">ask</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;choices&#39;</span> <span class="p">:</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="p">})</span>
</pre></div>

<p>Then we post the vote to the server to save it:</p>
<div class="highlight"><pre><a name="app--script.py-idio.html-29"></a><span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;choice&quot;</span><span class="p">:</span>
<a name="app--script.py-idio.html-30"></a>    <span class="n">vote_response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">VOTE_URL</span><span class="p">,</span> <span class="s">&quot;song=</span><span class="si">%s</span><span class="s">&amp;from=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">currentCall</span><span class="o">.</span><span class="n">callerID</span><span class="p">))</span>
<a name="app--script.py-idio.html-31"></a>    <span class="n">say</span><span class="p">(</span><span class="n">vote_response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>

<h3>Web API</h3>
<h2>Saving Vote</h2>
<p>The server page appends the vote to the database:</p>
<div class="highlight"><pre><a name="app--voting_scripting.py-idio.html-17"></a><span class="k">class</span> <span class="nc">VoteScriptingController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a name="app--voting_scripting.py-idio.html-18"></a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="app--voting_scripting.py-idio.html-19"></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;&amp;&quot;</span><span class="p">)</span>
<a name="app--voting_scripting.py-idio.html-20"></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<a name="app--voting_scripting.py-idio.html-21"></a>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
<a name="app--voting_scripting.py-idio.html-22"></a>            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
<a name="app--voting_scripting.py-idio.html-23"></a>            <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
<a name="app--voting_scripting.py-idio.html-24"></a>
<a name="app--voting_scripting.py-idio.html-25"></a>        <span class="n">song_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;song&quot;</span><span class="p">])</span>
<a name="app--voting_scripting.py-idio.html-26"></a>        <span class="n">models</span><span class="o">.</span><span class="n">votes</span><span class="o">.</span><span class="n">vote_for_song</span><span class="p">(</span><span class="n">song_number</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;from&quot;</span><span class="p">])</span>
<a name="app--voting_scripting.py-idio.html-27"></a>        <span class="n">song_title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">songs</span><span class="o">.</span><span class="n">song_title</span><span class="p">(</span><span class="n">song_number</span><span class="p">)</span>
<a name="app--voting_scripting.py-idio.html-28"></a>        <span class="k">return</span> <span class="s">&quot;You voted for song: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">song_title</span>
</pre></div>

<p>The votes model handles the appending:</p>
<div class="highlight"><pre><a name="models--votes.py-idio.html-33"></a><span class="k">def</span> <span class="nf">vote_for_song</span><span class="p">(</span><span class="n">song_number</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">):</span>
<a name="models--votes.py-idio.html-34"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a name="models--votes.py-idio.html-35"></a><span class="sd">    Insert a vote and increment the cache.</span>
<a name="models--votes.py-idio.html-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a name="models--votes.py-idio.html-37"></a>    <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;votes&#39;</span><span class="p">,</span> <span class="n">song_number</span><span class="o">=</span><span class="n">song_number</span><span class="p">,</span> <span class="n">phone_number</span><span class="o">=</span><span class="n">phone_number</span><span class="p">)</span>
<a name="models--votes.py-idio.html-38"></a>    <span class="n">models</span><span class="o">.</span><span class="n">songs</span><span class="o">.</span><span class="n">cache_vote</span><span class="p">(</span><span class="n">song_number</span><span class="p">)</span>
<a name="models--votes.py-idio.html-39"></a>    <span class="k">return</span> <span class="n">song_number</span>
</pre></div>

<div class="highlight"><pre><a name="models--songs.py-idio.html-29"></a><span class="k">def</span> <span class="nf">cache_vote</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
<a name="models--songs.py-idio.html-30"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a name="models--songs.py-idio.html-31"></a><span class="sd">    Increments the cached votes for this song.</span>
<a name="models--songs.py-idio.html-32"></a><span class="sd">    &quot;&quot;&quot;</span>
<a name="models--songs.py-idio.html-33"></a>    <span class="n">previous_votes_cache</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&quot;songs&quot;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&quot;number=$number&quot;</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">locals</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;votes_cache&#39;</span><span class="p">]</span>
<a name="models--songs.py-idio.html-34"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_votes_cache</span><span class="p">:</span>
<a name="models--songs.py-idio.html-35"></a>        <span class="n">previous_votes_cache</span> <span class="o">=</span> <span class="mi">0</span>
<a name="models--songs.py-idio.html-36"></a>    <span class="n">db</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;songs&quot;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&quot;number=$number&quot;</span><span class="p">,</span> <span class="n">votes_cache</span><span class="o">=</span><span class="n">previous_votes_cache</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">locals</span><span class="p">())</span>
</pre></div>

<p>We can view individual votes for debugging (to be removed):</p>
<div class="highlight"><pre><a name="docs--curl-votes.sh-pyg.html-1"></a>curl http://voice.pitchlift.org/votes
</pre></div>

<pre>
<pre>
Person calling from ananelson voted for Imagine by John Lennon (#2)
Person calling from ananelson voted for Sweet Caroline by Neil Diamond (#6)
Person calling from wchen_stanford voted for Daydream Believer by The Monkees (#5)
Person calling from wchen_stanford voted for Daydream Believer by The Monkees (#5)
Person calling from ananelson voted for Piano Man by Billy Joel (#1)
Person calling from wchen_stanford voted for Daydream Believer by The Monkees (#5)
Person calling from wchen_stanford voted for Piano Man by Billy Joel (#1)
</pre>
</pre>

<p>The app's home page shows us the songs and current vote tally:</p>
<div class="highlight"><pre><a name="docs--curl-home.sh-pyg.html-1"></a>curl http://voice.pitchlift.org
</pre></div>

<pre>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
    <head>
        <meta http-equiv="Content-type" content="text/html" />
        <title>Hey, Diggz, play my song!</title>
        <link href="/css/style.css" type="text/css"rel="stylesheet" />
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js">
        </script>
        <script type="text/javascript">
            function updater() {
                $.ajax({
                    url: '/results',
                    success: function(data) {
                       $('#results').html(data);
                    },
                    complete: function() {
                       setTimeout(updater, 5000);
                    }
                })
            };

            $(document).ready(function() {
                updater();
            });
        </script>
    </head>
    <body>
        <div class="zp-wrapper">
            <div class="zp-70 content">
                <div class="padding">
                    <p class="blue big">Hey, Diggz, play my song!</p>
                    <p class="blue">Call this number to vote: +990009369996194333</p>
                    <p class="blue">Current rankings:</p>
                    <ul id="results">
                        <li>Daydream Believer by The Monkees (3 votes)</li>
<li>Piano Man by Billy Joel (2 votes)</li>
<li>Imagine by John Lennon (1 votes)</li>
<li>Sweet Caroline by Neil Diamond (1 votes)</li>
<li>Rocket Man by Elton John (0 votes)</li>
<li>Crazy Little Thing Called Love by Queen (0 votes)</li>
<li>Hey Jude by The Beatles (0 votes)</li>
<li>Don't Stop Believin by Journey (0 votes)</li>
<li>Tainted Love by Soft Cell (0 votes)</li>
                    </ul>
                </div>
            </div>
        </div>
    </body>
</html>

</pre>
        </div>
    </div>
    </body>
</html>
